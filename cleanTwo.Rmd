---
title: "Hanover_Land_Use"
author: "Deep"
date: "2023-06-16"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#install.packages("sf")
#install.packages("leaflet")
#install.packages("writexl")
#install.packages("colorspace") 
#install.packages("RColorBrewer")
library(sf)
library(leaflet)
library(dplyr)
library(readxl)
library("writexl")
library(colorspace) 
library(RColorBrewer)
library(ggplot2)
library(plotly)
library(viridis)
```

* Set working directory. SAVE DATA FILES FROM TEAMS, CHANGE WD TO LOCATION YOU SAVE THEM AND ALL OTHER CODE SHOULD WORK 
```{r wd}
#setwd("C:/Users/ariadnetynes/Desktop/VT_DSPG/DSPG2023_VCE_Hanover")
```

# read in shapefile (most up to date version with some variables)
```{r wd}
shapefile <- st_read("Hanover_Parcels.shp")
```

# read in excel sheet (more parcel variables - tax assessed data)
```{r wd}
assess <- read_excel("Assessor_Data.xlsx")
```

# summarize zoning variable from shapefile 
```{r sum}
# Convert the vector to a factor (categorical variable)
categorical_var <- shapefile$ZONING_LIS
# Summarize the categorical variable
summary_stats <- table(categorical_var)
# View the summary statistics
print(summary_stats)
```

# summarize zoning variable from assessor data  
```{r sum}
# Convert the vector to a factor (categorical variable)
categorical_var <- assess$Zone
# Summarize the categorical variable
summary_stats <- table(categorical_var)
# View the summary statistics
print(summary_stats)
```

# Merge the two data sets to get one huge data set 
```{r }
merged_data <- merge(shapefile, assess, by.x = "GPIN", by.y = "GPIN")

# df data set shows the 4,631 parcels who do not have the same zone
fik <- merged_data[merged_data$Zone != merged_data$ZONING_LIS, ]
df <- fik[, c("Zone", "ZONING_LIS")]
```

#create combined variable for zone
```{r }
#dataset$newvariable <- ifelse(condition, if true, if false)
#condition = zoning variable is the same in both data sets
# if true = use the variable, if false = "NULL"
merged_data$comb_zone <- ifelse(merged_data$Zone == merged_data$ZONING_LIS, merged_data$Zone, "NULL")

#dataset$newvariable <- ifelse(condition, if true, if false)
#condition = zoning variable is "See Map" from most up-to-date, "shapefile" data set 
# if true = use the zoning variable from the assessor excel file
# if false = use most recent data set "shapefile"
merged_data$comb_zone <- ifelse(merged_data$ZONING_LIS == "See Map", merged_data$Zone, merged_data$ZONING_LIS)

# Specify the variables to relocate
variables_to_relocate <- c("GPIN", "comb_zone", "LOT_ACRES", "LAND_VALUE", "LEGALDESC")
# Relocate the variables - move important variables to front of data set 
merged_data <- merged_data %>%
  select(one_of(variables_to_relocate), everything())
```



# Summary stats for new, cleaned variable (comb_zone)
```{r sum}
allzones <- merged_data[, c("comb_zone", "Zone", "ZONING_LIS")]

# Convert the vector to a factor (categorical variable)
categorical_var <- merged_data$comb_zone
# Summarize the categorical variable
summary_stats <- table(categorical_var)
# View the summary statistics
print(summary_stats)
```

# create a variable for landuse - residential, commercial, industrial, agricultural, conservation 

```{r }
land_use <- function(comb_zone) {
  if (is.na(comb_zone)) {
    return("Missing")
  } else if (comb_zone == "RC" || comb_zone == "RR-C" || comb_zone == "RRC") {
    return("Conservation")
  } else if (comb_zone == "AR-1" || comb_zone == "AR-2" || comb_zone == "AR-3" || comb_zone == "AR-6") {
    return("Agriculture")
  } else if (comb_zone == "A-1") {
    return("Agriculture")
  } else if (comb_zone == "R-1" || comb_zone == "R-2" || comb_zone == "R-3" || comb_zone == "R-4" || comb_zone == "R-5" || comb_zone == "R-6" || comb_zone == "RS" || comb_zone == "RM" || comb_zone == "RR-1") {
    return("Residential")
  } else if (comb_zone == "B-1" || comb_zone == "B-2" || comb_zone == "B-20" || comb_zone == "B-2O"|| comb_zone == "B-4" || comb_zone == "B-3" || comb_zone == "B-O" || comb_zone == "B-0" ||comb_zone == "RS" || comb_zone == "RM" || comb_zone == "OS" || comb_zone == "O-S" || comb_zone == "RO-1" || comb_zone == "HE" || comb_zone == "PSC" || comb_zone == "MX" || comb_zone == "POB") {
    return("Commercial")
  } else if (comb_zone == "M-1" || comb_zone == "M-2" || comb_zone == "M-3") {
    return("Industrial")
  } else if (comb_zone == "PUD") {
    return("Construction")
  } else {
    return("Other")
  }
}

merged_data$land_use <- sapply(merged_data$comb_zone, land_use)

unique(merged_data$land_use)
```

```{r}
merged_data <- merged_data[merged_data$land_use != "Other", ]
merged_data <- merged_data[merged_data$land_use != "Missing", ]

unique(merged_data$land_use)
```

```{r}
#o <- merged_data[merged_data$land_use == "Other" ]
#new_df <- o[, c("land_use", "ZONING_LIS", "Zone", "LEGALDESC", "LOT_ACRES", "OWN_NAME1", "OWN_NAME2", "MAILINGADDRESS", "ADDRESS")]
```

```{r sum}
allzones <- merged_data[, c("land_use", "comb_zone", "Zone", "ZONING_LIS")]

# Convert the vector to a factor (categorical variable)
categorical_var <- merged_data$land_use
# Summarize the categorical variable
summary_stats <- table(categorical_var)
# View the summary statistics
print(summary_stats)
```

```{r}
# Read crop data and labels in
cropshape <- st_read("crop/cropbyparcel.shp")
croplabels <- read_excel("crop/croplabels.xlsx")
aggroup <- read_excel("crop/Ag_grouping_categorized.xlsx")

```

```{r}

# Merge aggroup and croplabels by class name
joined_labels <- left_join(croplabels, aggroup, by = c("Class_Name" = "Class_Names")) 

#Categorize for conoditional checks
filterRC <- joined_labels %>%
  filter(New_Label == "Row crops")

filterHC <- joined_labels %>% 
  filter(New_Label == "Horticulture crops")

filterSG <- joined_labels %>% 
  filter(New_Label == "Small grains")

filterDC <- joined_labels %>% 
  filter(New_Label == "Double cropped")

filterFR <- joined_labels %>%
  filter(New_Label == "Forages")

filterTR <- joined_labels %>%
  filter(New_Label == "Tree crops")

filterO <- joined_labels %>%
  filter(New_Label == "Other")

filterFO <- joined_labels %>%
  filter(New_Label == "Forested")

filterWL <- joined_labels %>% 
  filter(New_Label == "Wetlands")

filterW <- joined_labels%>%
  filter(New_Label == "Water")

filterDEV <- joined_labels %>%
  filter(New_Label == "Developed")

rowRC <- unique(filterRC$Value)
rowHC <- unique(filterHC$Value)
rowSG <- unique(filterSG$Value)
rowDC <- unique(filterDC$Value)
rowFR <- unique(filterFR$Value)
rowTR <- unique(filterTR$Value)
rowO <- unique(filterO$Value)
rowFO <- unique(filterFO$Value)
rowWL <- unique(filterWL$Value)
rowW <- unique(filterW$Value)
rowDEV <- unique(filterDEV$Value)

cropshape$crop_list <- apply(cropshape[, c("grd_cd1", "grd_cd2", "grd_cd3", "grd_cd4", "grd_cd5", "grd_cd6", "grd_cd7", "grd_cd8", "grd_cd9", "grd_c10", "grd_c11", "grd_c12", "grd_c13", "grd_c14", "grd_c15", "grd_c16", "grd_c17", "grd_c18", "grd_c19", "grd_c20", "grd_c21", "grd_c22", "grd_c23", "grd_c24")], 1, paste, collapse = ",")


# Create a new column of vectors based on conditional checks
cropshape$crpTypCon <- apply(cropshape[, "crop_list", drop = FALSE], 1, function(row) {
  categories <- c()  # Initialize an empty vector to store categories
  
  for (value in unlist(strsplit(as.character(row), ","))) {
    if (value %in% rowRC) {
      categories <- c(categories, "Row crops")
    } else if (value %in% rowHC) {
      categories <- c(categories, "Horticulture crops")
    } else if (value %in% rowSG) {
      categories <- c(categories, "Small grains")
    } else if (value %in% rowDC) {
      categories <- c(categories, "Double cropped")
    } else if (value %in% rowFR) {
      categories <- c(categories, "Forages")
    } else if (value %in% rowTR) {
      categories <- c(categories, "Tree crops")
    } else if (value %in% rowO) {
      categories <- c(categories, "Other")
    } else if (value %in% rowFO) {
      categories <- c(categories, "Forested")
    } else if (value %in% rowWL) {
      categories <- c(categories, "Wetlands")
    } else if (value %in% rowW) {
      categories <- c(categories, "Water")
    } else if (value %in% rowDEV) {
      categories <- c(categories, "Developed")
    }
  }
  
  if (length(categories) > 0) {
    list(categories)  # Return a list to store the vector as an element
  } else {
    list(NA)  # Return NA if no matching values were found
  }
})


```

```{r}
#saveRDS(cropshape, "C:/Users/deepd/Downloads/DSPG/DSPG2023_VCE_Hanover/DSPG2023_VCE_Hanover/cropshapeNew.rds")

loaded_cropdata <- readRDS( "C:/Users/deepd/Downloads/DSPG/DSPG2023_VCE_Hanover/DSPG2023_VCE_Hanover/cropshapeNew.rds")
```

```{r}

# NOTE: change column name issue later
crop_leaf <- loaded_cropdata %>%
  select(GPIN, geometry, crop_list, new_column)

```

```{r}

filterLeafRC <- crop_leaf %>%
  filter(grepl("Row crops", new_column))
# Row Crops Leaflet
#loading in the county outiline shapefile
hanover_boundary <- st_read("Hanover_County_Boundary/Hanover_County_Boundary.shp")
boundaryleaflet <- hanover_boundary %>%
  st_as_sf() 

leaflet() %>%
  addTiles() %>%
  addPolygons(data = filterLeafRC, fillColor = "lightpink", fillOpacity = 0.6, stroke = 1, color = "black", weight = 0.3) %>%
  addPolygons(data = boundaryleaflet, fillColor = "transparent",color = "black",fillOpacity = 0,weight = 1)
  
```

```{r}

filterLeafHC <- crop_leaf %>%
  filter(grepl("Horticulture crops", new_column))
# Row Crops Leaflet
#loading in the county outiline shapefile
hanover_boundary <- st_read("Hanover_County_Boundary/Hanover_County_Boundary.shp")
boundaryleaflet <- hanover_boundary %>%
  st_as_sf() 

leaflet() %>%
  addTiles() %>%
  addPolygons(data = filterLeafHC, fillColor = "#0000FF", fillOpacity = 0.6, stroke = 1, color = "black", weight = 0.3) %>%
  addPolygons(data = boundaryleaflet, fillColor = "transparent",color = "black",fillOpacity = 0,weight = 1)
  
```

```{r}

filterLeafSG <- crop_leaf %>%
  filter(grepl("Small grains", new_column))
# Row Crops Leaflet
#loading in the county outiline shapefile
hanover_boundary <- st_read("Hanover_County_Boundary/Hanover_County_Boundary.shp")
boundaryleaflet <- hanover_boundary %>%
  st_as_sf() 

leaflet() %>%
  addTiles() %>%
  addPolygons(data = filterLeafSG, fillColor = "#CC9900", fillOpacity = 0.6, stroke = 1, color = "black", weight = 0.3) %>%
  addPolygons(data = boundaryleaflet, fillColor = "transparent",color = "black",fillOpacity = 0,weight = 1)
  
```

```{r}

filterLeafDC <- crop_leaf %>%
  filter(grepl("Double cropped", new_column))
# Row Crops Leaflet
#loading in the county outiline shapefile
hanover_boundary <- st_read("Hanover_County_Boundary/Hanover_County_Boundary.shp")
boundaryleaflet <- hanover_boundary %>%
  st_as_sf() 

leaflet() %>%
  addTiles() %>%
  addPolygons(data = filterLeafDC, fillColor = "#FFCCFF", fillOpacity = 0.6, stroke = 1, color = "black", weight = 0.3) %>%
  addPolygons(data = boundaryleaflet, fillColor = "transparent",color = "black",fillOpacity = 0,weight = 1)
  
```

```{r}

filterLeafFR <- crop_leaf %>%
  filter(grepl("Forages", new_column))
# Row Crops Leaflet
#loading in the county outiline shapefile
hanover_boundary <- st_read("Hanover_County_Boundary/Hanover_County_Boundary.shp")
boundaryleaflet <- hanover_boundary %>%
  st_as_sf() 

leaflet() %>%
  addTiles() %>%
  addPolygons(data = filterLeafFR, fillColor = "#399966", fillOpacity = 0.6, stroke = 1, color = "black", weight = 0.3) %>%
  addPolygons(data = boundaryleaflet, fillColor = "transparent",color = "black",fillOpacity = 0,weight = 1)
  
```

```{r}

filterLeafTR <- crop_leaf %>%
  filter(grepl("Tree crops", new_column))
# Row Crops Leaflet
#loading in the county outiline shapefile
hanover_boundary <- st_read("Hanover_County_Boundary/Hanover_County_Boundary.shp")
boundaryleaflet <- hanover_boundary %>%
  st_as_sf() 

leaflet() %>%
  addTiles() %>%
  addPolygons(data = filterLeafTR, fillColor = "#000000", fillOpacity = 0.6, stroke = 1, color = "black", weight = 0.3) %>%
  addPolygons(data = boundaryleaflet, fillColor = "transparent",color = "black",fillOpacity = 0,weight = 1)
  
```

```{r}

filterLeafO <- crop_leaf %>%
  filter(grepl("Other", new_column))
# Row Crops Leaflet
#loading in the county outiline shapefile
hanover_boundary <- st_read("Hanover_County_Boundary/Hanover_County_Boundary.shp")
boundaryleaflet <- hanover_boundary %>%
  st_as_sf() 

leaflet() %>%
  addTiles() %>%
  addPolygons(data = filterLeafO, fillColor = "#330000", fillOpacity = 0.6, stroke = 1, color = "black", weight = 0.3) %>%
  addPolygons(data = boundaryleaflet, fillColor = "transparent",color = "black",fillOpacity = 0,weight = 1)
  
```

```{r}

filterLeafFO <- crop_leaf %>%
  filter(grepl("Forested", new_column))
# Row Crops Leaflet
#loading in the county outiline shapefile
hanover_boundary <- st_read("Hanover_County_Boundary/Hanover_County_Boundary.shp")
boundaryleaflet <- hanover_boundary %>%
  st_as_sf() 

leaflet() %>%
  addTiles() %>%
  addPolygons(data = filterLeafFO, fillColor = "#003000", fillOpacity = 0.6, stroke = 1, color = "black", weight = 0.3) %>%
  addPolygons(data = boundaryleaflet, fillColor = "transparent",color = "black",fillOpacity = 0,weight = 1)
  
```

```{r}

filterLeafWL <- crop_leaf %>%
  filter(grepl("Wetlands", new_column))
# Row Crops Leaflet
#loading in the county outiline shapefile
hanover_boundary <- st_read("Hanover_County_Boundary/Hanover_County_Boundary.shp")
boundaryleaflet <- hanover_boundary %>%
  st_as_sf() 

leaflet() %>%
  addTiles() %>%
  addPolygons(data = filterLeafWL, fillColor = "#00CCFF", fillOpacity = 0.6, stroke = 1, color = "black", weight = 0.3) %>%
  addPolygons(data = boundaryleaflet, fillColor = "transparent",color = "black",fillOpacity = 0,weight = 1)
  
```

```{r}

filterLeafRC <- crop_leaf %>%
  filter(grepl("Water", new_column))
# Row Crops Leaflet
#loading in the county outiline shapefile
hanover_boundary <- st_read("Hanover_County_Boundary/Hanover_County_Boundary.shp")
boundaryleaflet <- hanover_boundary %>%
  st_as_sf() 

leaflet() %>%
  addTiles() %>%
  addPolygons(data = filterLeafRC, fillColor = "#0033FF", fillOpacity = 0.6, stroke = 1, color = "black", weight = 0.3) %>%
  addPolygons(data = boundaryleaflet, fillColor = "transparent",color = "black",fillOpacity = 0,weight = 1)
  
```

```{r}
filterLeafDEV <- crop_leaf %>%
  filter(grepl("Developed", new_column))
# Row Crops Leaflet
#loading in the county outiline shapefile
hanover_boundary <- st_read("Hanover_County_Boundary/Hanover_County_Boundary.shp")
boundaryleaflet <- hanover_boundary %>%
  st_as_sf() 

leaflet() %>%
  addTiles() %>%
  addPolygons(data = filterLeafDEV, fillColor = "orange", fillOpacity = 0.6, stroke = 1, color = "black", weight = 0.3) %>%
  addPolygons(data = boundaryleaflet, fillColor = "transparent",color = "black",fillOpacity = 0,weight = 1)
```